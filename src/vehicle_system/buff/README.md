# 能量机关模块
## 优化点：
    1.尝试手写梯度下降法进行非线性拟合，提高拟合速度；
    2.将曲线拟合部分与预测部分分开，两个线程单独工作，提高预测速度；
    3.尝试从拟合角速度-时间曲线变成拟合角度-时间曲线（将三维预测变换到二维预测)；
    4.轨迹点抽样。

### 1.拟合与预测多线程实现
        拟合与预测部分单开线程同步运行。拟合部分如果成功则修改预测部分输入的参数，反之预测部分继续使用之前拟合出的参数。
### 2.角度-时间函数拟合
        角速度是角度的微分，角度本身求解存在一定误差，微分后会放大误差，因此拟合角度-时间函数更合理。
        在三维进行角度-时间拟合会因为测距方向的较大误差拟合效果不会太好，因此考虑将三维拟合变换到二维，一种做法是将云台坐标系旋转到一轴垂直于能量机关平面，即在与能量机关平面平行的二维平面上拟合角度-时间函数。要将云台坐标系旋转到一轴垂直与能量机关平面，主要是求解pitch轴需要旋转的角度（能量机关yaw轴方向几乎与云台坐标系yaw轴方向一致，可以忽略），问题至此已经明确，接下来是如何求解。
        已知条件：能量机关中心R标的三维坐标（云台坐标系下）和扇叶上装甲板中心的三维坐标（云台坐标系）。
记中心R标的三维坐标为$O(x_{0},y_{0},z_{0})$(分别对应水平轴、竖直轴、垂直轴)、装甲板中心的坐标为$P(x_{1},y_{1},z_{1})$，定义能量机关pitch轴方向与云台坐标系pitch轴方向的夹角为$\theta$。
求解：
$$
        1.求出P点在能量机关平面pitch轴的投影点P^{'}=(x_{1},y_{0},z_{1})；\\        

        2.求解\theta角对应的正切值tan\theta=\lvert\frac{z_{1}-z_{0}}{x_{1}-x_{0}}\rvert，\\
        
        则\theta=arctan\lvert\frac{z_{1}-z_{0}}{x_{1}-x_{0}}\rvert
$$
        角度-时间函数可由官方给出的转速-时间函数关系式积分求出。
推导：
$$
        转速f(t)与时间t之间的关系满足：  f(t)=asin(wt+\phi)+b \\
        对上式进行不定积分得：\\
                {\int}f(t)={\int}[asin(wt+\phi)+b] \\
                        =-\frac{a}{w}cos(wt+\phi)+bt+C \\
        即角度{\theta}与时间t的关系满足：\\
                {\theta}=-\frac{a}{w}cos(wt+\phi)+bt+C \\
        式中C是常数项，为消去此项，我们假设t=0时，{\theta}=0。 \\
        代入式中得： \\
                -\frac{a}{w}cos{\phi}+C=0 \\
        即得：
                C=\frac{a}{w}cos{\phi} \\
        故最终得关系式为： \\
                {\theta}=-\frac{a}{w}cos(wt+\phi)+bt+\frac{a}{w}cos{\phi}
$$
        角度-时间拟合要考虑角度的连续性与准确性。能量机关各个扇叶转速相同，同一时刻角度的求解可以由各个扇叶角度的融合得出，角度的连续性的处理可以定义一个角度零点，此后每一个时刻的角度都转化到此角度零点对应的角度，由于每个扇叶间角度差是定值，因此此方法可行。
### 3.数据处理
        单目pnp解算出的距离信息误差较大，但是解算出的pitch和yaw角度则较为准确，因此可以尝试对距离方向的解算做特化处理，考虑到激活能量机关是在固定点位，因此对于中心R在距离方向的计算可以通过采集固定帧后过均值滤波求得（可能更符合正态分布），然后根据pitch和yaw轴角度反推出中心R其它两轴坐标，进而求出每一帧pnp解算出的距离方向的值与均值的比值，进而求出每个扇叶装甲板中心的均值，并反推出对应的其他两轴坐标。
        大符角度的解算不可避免会出现异常值，在角度连续变化的过程中可能会出现一帧或多帧角度跳变值，而出现跳变的原因也不止一个，可能是大符扇叶发生切换导致角度出现跳变，也可能是单目解算误差较大导致的跳变值。因此只根据角度的跳变无法判断到底是那种原因，也就无法对数据做进一步的处理。我们需要额外引入条件辅助判断，目前考虑大符的半径在三维坐标系下是定值，所以可以把单目解算出大符半径限定在一定范围内，超出范围则认定角度解算数据异常，对此数据做其他处理。两种处理方法，若还未激活一个扇叶，则根据历史角度信息对当前帧数据进行插值补充；若已有激活扇叶，则根据已激活扇叶的角度变化对当前帧待激活扇叶进行角度补偿，若已激活扇叶的角度也出现异常，则同样进行插值处理。
